<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">

    <title>lazy module loading</title>

    <meta name="keywords" content="racket">
    <meta name="canonical" href="https://rmculpepper.github.io/blog/2011/10/lazy-module-loading">
    <meta rel="alternate" type="application/atom+xml" title="Atom Feed"
          href="/blog/feeds/all.atom.xml">
    <link rel="prev" href="/blog/2011/10/in-praise-of-PostgreSQL-arrays">
    <link rel="next" href="/blog/2011/09/definitions-vs-enclosing-binding-forms">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/blog/favicon.png">
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css"
          integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-min.css"
          integrity="sha384-e+NM0rMilIXo+lz6+dXhoHMjd2iTSxNsCHpqkvuSBsAhwMDRF/Wn2QRRNaLxTcN/"
          crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/blog/css/pure-blog.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/custom.css">

  </head>
  <body>


    <div class="layout pure-g">
      <div class="titlebar pure-u-1">
        <div class="header">
          <h1 class="site-title"><a href="/blog/">One Racketeer</a></h1>

          <h2 class="site-tagline">the blog of Ryan Culpepper</h2>
          <h2 class="site-alt-tagline">
            (blog-of ryanc@racket-lang.org)
          </h2>
          <nav class="nav">
            <ul class="nav-list">
              <li class="nav-item">
                <a class="pure-button" href="/blog/tags/db.html">db</a>
              </li><li class="nav-item">
                     <a class="pure-button" href="/blog/tags/macros.html">macros</a>
                   </li><li class="nav-item">
                          <a class="pure-button" href="/blog/tags/racket.html">racket</a>
                        </li>
            </ul>
          </nav>
        </div>
      </div>
      <div class="content pure-u-1">

        <div class="content-inner">


          <article class="post">
  <header class="post-header">
    <h1 class="post-title">lazy module loading</h1>
    <div class="post-meta">
      <div class="authors">By: Ryan Culpepper</div>
      <span class="post-date"><time datetime="2011-10-16">2011-10-16</time></span>
      <span class="post-tags"><a href="/blog/tags/racket.html">racket</a></span>
    </div>
  </header>
  <p>The Racket module system is good at managing dependencies. When you
<span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span> a module, you ensure that that module is initialized
before your code runs, and when the other module changes, the compiler
will notice and recompile your module too. Racket even stratifies
dependencies according to <a class="Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/stx-phases.html">phase
levels</a> so you can use some modules in your macro implementations and
other modules in your run-time code and the expander/compiler/linker
knows
<a href="http://www.cs.utah.edu/plt/publications/macromod.pdf">what
you want when</a>. It keeps track and makes sure that everything is
loaded and available when it&rsquo;s supposed to be.</p>
<p>But sometimes you want to manage dependencies yourself. This post
is about how to <span style="font-style: italic">lazily load</span> the implementations of functions
and&#8212;<wbr></wbr>with a bit of care&#8212;<wbr></wbr>even macros.</p>
<h2><a name="(part._.Why_)"></a>Why?</h2>
<p>One reason to lazily load a module is if it depends on foreign
libraries, for example, and you don&rsquo;t to try to load them if the user
doesn&rsquo;t actually use them. My <a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/db/index.html"><span class="RktSym">db</span></a> library does this;
there&rsquo;s no point complaining about a missing
<a href="http://www.sqlite.org">SQLite</a> library if the user wants
to connect to a <a href="http://www.postgresql.org">PostgreSQL</a>
server. Of course, it&rsquo;s possible to put the library loading inside a
<span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span> or a <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/creatingunits.html#%28form._%28%28lib._racket%2Funit..rkt%29._unit%29%29">unit</a></span>, but you need to keep propagating
the delaying mechanism up until you either deal with it or dump it in
the user&rsquo;s lap.</p>
<p>Another reason is to select an implementation at run time. Racket&rsquo;s
GUI system works this way, for example. There are three
implementations (using system-specific foreign libraries) and
<a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/gui/index.html"><span class="RktSym">racket/gui</span></a> picks the appropriate one at run time.</p>
<p>Yet another reason is to simply avoid loading code that is unlikely to
be used. When a module is loaded, all of its normal dependencies
(those introduced by <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span>, whatever the phase) are also
loaded&#8212;<wbr></wbr>including the code for any macros and their compile-time
support. To be clear, the modules are only <span style="font-style: italic">instantiated</span> if
they&rsquo;re needed for execution or compilation, but their bytecode
is loaded into memory regardless.</p>
<p>Consider what that means for a language such as Typed Racket: loading
any typed program would also load the type-checker and optimizer&#8212;<wbr></wbr>if
Typed Racket played by the normal rules. In fact, Typed Racket lazily
loads most of its compile-time components precisely so that compiled
typed programs won&rsquo;t depend on them. (Credit goes to
<a href="http://www.ccs.neu.edu/home/samth">Sam TH</a> for showing me
the lazy-loading trick for macros. As I recall, I was initiallly
aghast at the idea until he explained the performance implications
of the normal loading strategy.)</p>
<h2><a name="(part._.Lazy_.Loading_for_.Functions)"></a>Lazy Loading for Functions</h2>
<p>In principle, lazily loading a module is easy. Although Racket
presents a pleasant illusion of a static module graph, it&rsquo;s really all
built on top of dynamic pieces. The primary relevant tool is
<span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span>. Instead of using <span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span>
directly, though, let&rsquo;s define a <span class="RktKw">lazy-require</span> form that
creates function proxy definitions that automatically call
<span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span> when necessary. Here&rsquo;s a first cut:</p>
<div class="SCodeFlow"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><span class="RktPn">(</span><span class="RktKw">lazy-require</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktVar">mod</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktVar">function-id</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td>&#8658;</td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin%29%29">begin</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktVar">function-id</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%29%29">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Delayed_Evaluation.html#%28form._%28%28lib._racket%2Fpromise..rkt%29._delay%29%29">delay</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">mod</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">function-id</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktSym">args</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/procedures.html#%28def._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._apply%29%29">apply</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Delayed_Evaluation.html#%28def._%28%28lib._racket%2Fpromise..rkt%29._force%29%29">force</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">args</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span></td></tr></tbody></table></div>
<p></p>
<div class="SIntrapara">That&rsquo;s the basic idea. But there are several major problems with this
first cut:
</div>
<div class="SIntrapara"><ul><li><p><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span> uses the <a class="techoutside Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/syntax-model.html#%28tech._current._namespace%29"><span class="techinside">current
namespace</span></a>, which might not have the same <a class="techoutside Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/syntax-model.html#%28tech._module._registry%29"><span class="techinside">module
registry</span></a> the enclosing module was loaded in (see
also <a class="Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/mk-namespace.html">Manipulating Namespaces</a>).</p></li><li><p>If <span class="RktVar">mod</span> is a relative <a class="techoutside Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/module-paths.html#%28tech._module._path%29"><span class="techinside">module path</span></a>,
<span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span> will try to resolve it relative to the
current directory rather than the location of the enclosing module.</p></li><li><p>It breaks <span class="stt">raco exe</span>, since there&rsquo;s no indication to
the compiler that <span class="RktVar">mod</span> should be included in the executable.</p></li></ul></div>
<p>The solution to the first problem is to use
<span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Namespaces.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define-namespace-anchor%29%29">define-namespace-anchor</a></span> and
<span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Namespaces.html#%28def._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._namespace-anchor-~3enamespace%29%29">namespace-anchor-&gt;namespace</a></span>. The second and third problems
are both solved by using <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Filesystem.html#%28form._%28%28lib._racket%2Fruntime-path..rkt%29._define-runtime-module-path-index%29%29">define-runtime-module-path-index</a></span>.</p>
<div class="SCodeFlow"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><span class="RktPn">(</span><span class="RktKw">lazy-require</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktVar">mod</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktVar">function-id</span><span class="hspace">&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td>&#8658;</td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin%29%29">begin</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Namespaces.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define-namespace-anchor%29%29">define-namespace-anchor</a></span><span class="hspace">&nbsp;</span><span class="RktSym">anchor</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Filesystem.html#%28form._%28%28lib._racket%2Fruntime-path..rkt%29._define-runtime-module-path-index%29%29">define-runtime-module-path-index</a></span><span class="hspace">&nbsp;</span><span class="RktSym">mpi</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">mod</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktVar">function-id</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%29%29">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Delayed_Evaluation.html#%28form._%28%28lib._racket%2Fpromise..rkt%29._delay%29%29">delay</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/parameters.html#%28form._%28%28lib._racket%2Fprivate%2Fmore-scheme..rkt%29._parameterize%29%29">parameterize</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Namespaces.html#%28def._%28%28quote._~23~25kernel%29._current-namespace%29%29">current-namespace</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Namespaces.html#%28def._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._namespace-anchor-~3enamespace%29%29">namespace-anchor-&gt;namespace</a></span><span class="hspace">&nbsp;</span><span class="RktSym">anchor</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span><span class="hspace">&nbsp;</span><span class="RktSym">mpi</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">function-id</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktSym">args</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/procedures.html#%28def._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._apply%29%29">apply</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Delayed_Evaluation.html#%28def._%28%28lib._racket%2Fpromise..rkt%29._force%29%29">force</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">args</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29">...</a></span><span class="RktPn">)</span></td></tr></tbody></table></div>
<p>There are still some little problems left. This version doesn&rsquo;t work
for functions with keyword arguments. Solution:
<span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/procedures.html#%28def._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._make-keyword-procedure%29%29">make-keyword-procedure</a></span> and <span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/procedures.html#%28def._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._keyword-apply%29%29">keyword-apply</a></span>. And the
promise created by <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Delayed_Evaluation.html#%28form._%28%28lib._racket%2Fpromise..rkt%29._delay%29%29">delay</a></span> is not reentrant; if multiple
threads try to force a function&rsquo;s loading simultaneously, it&rsquo;ll raise
an error. Solution: <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Delayed_Evaluation.html#%28form._%28%28lib._racket%2Fpromise..rkt%29._delay%2Fsync%29%29">delay/sync</a></span>.</p>
<p>It would also be nice if <span class="RktKw">lazy-require</span> worked for values other
than functions. One way to make that work is to bind each name as an
identifier macro instead of creating a proxy function.</p>
<h2><a name="(part._.Lazy_.Loading_for_.Macros)"></a>Lazy Loading for Macros</h2>
<p>So far, the <span class="RktKw">lazy-require</span> macro only lets us access value
exports. Can we lazily require a macro?</p>
<p>The short answer is no.</p>
<p>There are two reasons why it won&rsquo;t work, one shallow and one deep. The
shallow reason is that <span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span> can only be used with
value exports. We&rsquo;d need something else&#8212;<wbr></wbr>let&rsquo;s call it
<span class="RktSym">dynamic-require-syntax-local-value</span>. Let&rsquo;s pretend that
<span class="RktSym">dynamic-require-syntax-local-value</span> would give us the
compile-time value of an export bound as syntax&#8212;<wbr></wbr>for example, given a
macro name it would fetch the macro transformer. That would give us
just enough rope to hang ourselves, because the other reason it won&rsquo;t
work has to do with how Racket handles inter-module references&#8212;<wbr></wbr>in
other words, linking.</p>
<p>Consider the following modules:</p>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"private/run-forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">run-forever</span><span class="hspace">&nbsp;</span><span class="RktSym">thunk</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">thunk</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">run-forever</span><span class="hspace">&nbsp;</span><span class="RktSym">thunk</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktSym">run-forever</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"private/run-forever.rkt"</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fmisc..rkt%29._define-syntax-rule%29%29">define-syntax-rule</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">run-forever</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktKw">forever</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"five-yo.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"forever.rkt"</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktKw">forever</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin%29%29">begin</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Byte_and_String_Input.html#%28def._%28%28quote._~23~25kernel%29._read-line%29%29">read-line</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Writing.html#%28def._%28%28quote._~23~25kernel%29._display%29%29">display</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Why?\n"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<p>When the use of <span class="RktKw">forever</span> in <span class="RktVal">"five-yo.rkt"</span> is
expanded, it leaves behind a reference to <span class="RktSym">run-forever</span>. (In
this context, I&rsquo;ll call that a <a name="(tech._residual._reference)"></a><span style="font-style: italic">residual reference</span>, which
implies a <a name="(tech._residual._dependency)"></a><span style="font-style: italic">residual dependency</span> on the module defining it.)
How should that reference be represented in bytecode? One possibility
is &ldquo;the variable named <span class="RktSym">run-forever</span> defined in
<span class="RktVal">"/abs/path/to/private/run-forever.rkt"</span>.&rdquo;  But if we
hard-wired full filesystem paths into bytecode, we wouldn&rsquo;t be able to
compile it on one machine and install it on another, which would make
distributing Racket and Racket programs difficult. So instead,
the source of the reference is represented as a <a class="techoutside Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28tech._module._path._index%29"><span class="techinside">module
path index</span></a>: a chain of relative module references usually ending in
<span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._module-path-index-join%29%29">module-path-index-join</a></span><span class="stt"> </span><span class="RktVal">#f</span><span class="stt"> </span><span class="RktVal">#f</span><span class="RktPn">)</span>, which means &ldquo;the enclosing
module,&rdquo; roughly. The source of <span class="RktSym">run-forever</span> is represented as</p>
<div class="SCodeFlow"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._module-path-index-join%29%29">module-path-index-join</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"private/run-forever.rkt"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._module-path-index-join%29%29">module-path-index-join</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"forever.rkt"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._module-path-index-join%29%29">module-path-index-join</a></span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></div>
<p>When the compiled form of <span class="RktVal">"five-yo.rkt"</span> is loaded,
it first loads its immediate dependencies
(<span class="RktVal">"forever.rkt"</span>) and they load their immediate
dependencies (<span class="RktVal">"private/run-forever.rkt"</span>) and so
on. Then it resolves the module path index for each reference&rsquo;s source
and links the reference to that actual module declaration. The
collection root and project root can change, as long as all relative
paths are preserved. (Otherwise, the Racket linker raises an error.)</p>
<p>What if we were to load <span class="RktVal">"forever.rkt"</span> lazily?</p>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"five-yo.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktKw">hypothetical-lazy-require-macro</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktVal">"forever.rkt"</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktKw">forever</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin%29%29">begin</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Byte_and_String_Input.html#%28def._%28%28quote._~23~25kernel%29._read-line%29%29">read-line</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Writing.html#%28def._%28%28quote._~23~25kernel%29._display%29%29">display</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Why?\n"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<p>By linking dynamically, we disrupt the chain of relative module paths;
<span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span> (and its hypothetical extension) have no tie
to the module currently being expanded&#8212;<wbr></wbr>which, after all, may or may
not be the module that contains the <span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span>
call. Instead, the residual reference to <span class="RktSym">run-forever</span> would
have a source that looks something like this:</p>
<div class="SCodeFlow"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._module-path-index-join%29%29">module-path-index-join</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"private/run-forever.rkt"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._make-resolved-module-path%29%29">make-resolved-module-path</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"/abs/path/to/forever.rkt"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></tbody></table></div>
<p>which Racket would refuse to write to a <span style="font-weight: bold">zo</span>-file.</p>
<p>So what <span style="font-style: italic">does</span> work?</p>
<p>Follow this recipe to lazily load transformation dependencies:</p>
<ol><li><p>Group your code into <span style="font-style: italic">interface</span>, <span style="font-style: italic">transformation</span>,
and <span style="font-style: italic">residual</span> modules.</p></li><li><p>Add a &ldquo;bridge&rdquo; transformation module to get around
<span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span>&rsquo;s phase limitations.</p></li><li><p>Use absolute module paths in all requires between the different
kinds of modules.</p></li><li><p>Change the interface-to-transformation requires to use
<span class="RktKw">lazy-require</span>, still with absolute module paths.</p></li></ol>
<p>I&rsquo;ll elaborate on each of those steps. Each step, if done correctly,
produces a working program/library; the final step just flips on lazy
loading of transformation code.</p>
<p><span style="font-weight: bold">Group your code into <span style="font-style: italic">interface</span>, <span style="font-style: italic">transformation</span>,
and <span style="font-style: italic">residual</span> modules.</span> The interface modules are those required
by clients, and the residual modules are the ones that satisfy
residual dependencies in the code your macros produce. The
transformation modules are the ones that are only necessary during
transformation. The fact that they &ldquo;disappear&rdquo; from a compiled
module&rsquo;s dependencies is the win of the whole approach. If there&rsquo;s not
much in your transformation modules, then stop. Don&rsquo;t bother. It&rsquo;s not
worth it.</p>
<p>Here&rsquo;s our <span class="RktKw">forever</span> macro reorganized. We&rsquo;ll go
bottom-up. Here&rsquo;s the single residual module:</p>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"private/run-forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">run-forever</span><span class="hspace">&nbsp;</span><span class="RktSym">thunk</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">thunk</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">run-forever</span><span class="hspace">&nbsp;</span><span class="RktSym">thunk</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktSym">run-forever</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<p>If we had previously defined <span class="RktSym">run-forever</span> in the same module
as the <span class="RktKw">forever</span> macro, we would need to separate them at this
stage.</p>
<p>There are many ways to separate out the transformation part, but the
easiest is to take the existing macro(s) and move them to new
private transformation module(s):</p>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"private/trans-forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"run-forever.rkt"</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fmisc..rkt%29._define-syntax-rule%29%29">define-syntax-rule</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">run-forever</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktKw">forever</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<p>Now we add an interface module:</p>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._only-in%29%29">only-in</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"private/run-forever.rkt"</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._prefix-in%29%29">prefix-in</a></span><span class="hspace">&nbsp;</span><span class="RktSym">t:</span><span class="hspace">&nbsp;</span><span class="RktVal">"private/trans-forever.rkt"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fmisc..rkt%29._define-syntax-rule%29%29">define-syntax-rule</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">t:forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktKw">forever</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<p>The interface module(s) must require the residual module(s) directly
to make sure they get loaded, because the dependency through the
transformation modules will disappear when we get to the final
step. Since the interface module doesn&rsquo;t need any of its exports, we
use <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._only-in%29%29">only-in</a></span> and ask for none of the bindings; that still
introduces a dependency. We also define a new <span class="RktKw">forever</span> macro
that expands into the other one. We could have simply reprovided
<span class="RktKw">forever</span> for now, but the indirection macro will become useful
later.</p>
<p>When separating your modules, don&rsquo;t confuse <span style="font-style: italic">transformation</span> with
<span style="font-style: italic">compile-time</span> and <span style="font-style: italic">residual</span> with <span style="font-style: italic">run-time</span>. They do
often coincide&#8212;<wbr></wbr>in Typed Racket, for example, the type checker and
optimizer are compile-time and <span style="font-style: italic">transformation</span>
components. However, Typed Racket also inserts code into a compiled
typed module, to be executed when the module is visited, to add its
bindings to a global type environment; thus the type environment code
is <span style="font-style: italic">compile-time</span> but <span style="font-style: italic">residual</span>.</p>
<p><span style="font-weight: bold">Add a &ldquo;bridge&rdquo; transformation module</span> to get around
<span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span>&rsquo;s phase limitations. Specifically,
<span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/Module_Names_and_Loading.html#%28def._%28%28quote._~23~25kernel%29._dynamic-require%29%29">dynamic-require</a></span> can only get <span style="font-style: italic">value</span> bindings provided
from <span style="font-style: italic">phase 0</span> of a module. So we add the following:</p>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"private/bridge-forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for-template%29%29">for-template</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"trans-forever.rkt"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">get-forever-id</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktKw">forever</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktSym">get-forever-id</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<p>We need to provide some sort of handle for the <span class="RktKw">forever</span> macro,
but we need to provide it at phase 0&#8212;<wbr></wbr>with the knowledge that we&rsquo;ll
be required at phase 1 (<span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for-syntax%29%29">for-syntax</a></span>). For the phases to work
out, that means we must require the macro&rsquo;s module at phase -1
(<span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for-template%29%29">for-template</a></span>).</p>
<p>How, then, do we represent a handle for the macro? One possibility is
to just provide its transformer; but that would require
<span class="RktVal">"private/trans-forever.rkt"</span> to have defined it as a
separate phase-1 function and provided it <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for-syntax%29%29">for-syntax</a></span>. The
alternative is to use an identifier that acts as a reference to the
macro.</p>
<p>We also change the interface module to use the additional identifier
indirection:</p>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._only-in%29%29">only-in</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"private/run-forever.rkt"</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for-syntax%29%29">for-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"private/bridge-forever.rkt"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define-syntax%29%29">define-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax-case%29%29">syntax-case</a></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._with-syntax%29%29">with-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">real-forever</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">get-forever-id</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">real-forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktKw">forever</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<p>In other words, we lazily load the <span style="font-style: italic">name</span> of the &ldquo;real&rdquo; macro,
relying on the fact that if we actually use the name, we&rsquo;ve also
loaded the macro implementation itself (because
<span class="RktVal">"bridge-forever.rkt"</span> has a strict dependency on
<span class="RktVal">"trans-forever.rkt"</span>).</p>
<p><span style="font-weight: bold">Use absolute module paths in all requires between the different
kinds of modules.</span> This is necessary to avoid unmarshallable module
path indexes later. Easiest is to put the code in a collection
library.</p>
<p></p>
<div class="SIntrapara">(If you&rsquo;re following along, just run </div>
<div class="SIntrapara"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">raco link --name</span><span class="stt">
</span><span class="stt">somelib .</span></div>
<div class="SIntrapara"> in the directory with the interface module&#8212;<wbr></wbr>now that
directory is a collection library directory! Remember to unlink it
when you&rsquo;re done&#8212;<wbr></wbr>use the <span class="stt">-r</span> flag.)</div>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"private/run-forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">no changes</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">run-forever</span><span class="hspace">&nbsp;</span><span class="RktSym">thunk</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">thunk</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">run-forever</span><span class="hspace">&nbsp;</span><span class="RktSym">thunk</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktSym">run-forever</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"private/trans-forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">abs. mod. path</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktSym">somelib/private/run-forever</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fmisc..rkt%29._define-syntax-rule%29%29">define-syntax-rule</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">run-forever</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/lambda.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._lambda%29%29">lambda</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktKw">forever</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"private/bridge-forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">no changes</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for-template%29%29">for-template</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"trans-forever.rkt"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">get-forever-id</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktKw">forever</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktSym">get-forever-id</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">abs. mod. path</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._only-in%29%29">only-in</a></span><span class="hspace">&nbsp;</span><span class="RktSym">somelib/private/run-forever</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for-syntax%29%29">for-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktSym">somelib/private/bridge-forever</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define-syntax%29%29">define-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax-case%29%29">syntax-case</a></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._with-syntax%29%29">with-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">real-forever</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">get-forever-id</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">real-forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktKw">forever</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<p>Note that <span class="RktVal">"bridge-forever.rkt"</span> can <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span>
<span class="RktVal">"trans-forever.rkt"</span> using a relative module path
because they&rsquo;re both transformation modules.</p>
<p><span style="font-weight: bold">Change the interface-to-transformation requires to use
<span class="RktKw">lazy-require</span>, still with absolute module paths.</span> We&rsquo;ll need
to put the <span class="RktKw">lazy-require</span> within a <span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin-for-syntax%29%29">begin-for-syntax</a></span>
block.</p>
<div class="SCodeFlow"><blockquote class="Rfilebox"><p class="Rfiletitle"><span class="Rfilename"><span class="stt">"forever.rkt"</span></span></p><blockquote class="Rfilecontent"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/guide/Module_Syntax.html#%28part._hash-lang%29"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._only-in%29%29">only-in</a></span><span class="hspace">&nbsp;</span><span class="RktSym">somelib/private/run-forever</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._for-syntax%29%29">for-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktSym">unstable/lazy-require</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin-for-syntax%29%29">begin-for-syntax</a></span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktKw">lazy-require</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">somelib/private/bridge-forever</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">get-forever-id</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define-syntax%29%29">define-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax-case%29%29">syntax-case</a></span><span class="hspace">&nbsp;</span><span class="RktSym">stx</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktKw">forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._with-syntax%29%29">with-syntax</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">real-forever</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">get-forever-id</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">real-forever</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29">provide</a></span><span class="hspace">&nbsp;</span><span class="RktKw">forever</span><span class="RktPn">)</span></td></tr></tbody></table></blockquote></blockquote></div>
<p>That&rsquo;s it! Now the real implementation of <span class="RktKw">forever</span> (that is,
<span class="RktVal">"private/trans-forever.rkt"</span>) is only loaded when a use
of <span class="RktKw">forever</span> needs to be expanded.</p>
<p>We can even test this:</p>
<div class="SCodeFlow"><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktStxLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29">require</a></span><span class="hspace">&nbsp;</span><span class="RktSym">macro-debugger/analysis/show-dependencies</span><span class="RktPn">)</span></td></tr><tr><td><table cellpadding="0" cellspacing="0" class="RktBlk"><tbody><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a class="RktValLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/macro-debugger/index.html#%28def._%28%28lib._macro-debugger%2Fanalysis%2Fshow-dependencies..rkt%29._show-dependencies%29%29">show-dependencies</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">file</span><span class="hspace">&nbsp;</span><span class="RktVal">"five-yo.rkt"</span><span class="RktVal">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:exclude</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">racket</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr></tbody></table></td></tr><tr><td><table cellpadding="0" cellspacing="0"><tbody><tr><td><p><span class="RktOut">somelib/private/run-forever</span></p></td></tr><tr><td><p><span class="RktOut">"forever.rkt"</span></p></td></tr></tbody></table></td></tr></tbody></table></div>
<p>That is, the only modules that <span class="RktVal">"five-yo.rkt"</span> depends on
(not including <a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/index.html"><span class="RktSym">racket</span></a> and its dependencies) are
<span class="RktSym">somelib/private/run-forever</span> and
<span class="RktVal">"forever.rkt"</span>.</p>
<p>The recipe above works for plain old macros, but not other kinds of
static bindings like <a class="techoutside Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/stxparam.html#%28tech._syntax._parameter%29"><span class="techinside">syntax parameters</span></a>, struct names,
or unit <a class="techoutside Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/mzlib_unit.html#%28tech._signature%29"><span class="techinside">signatures</span></a>. Those you&rsquo;ll just have to put in
the residual modules or not use lazy loading at all.</p>
<h2><a name="(part._.Is_.It_.Worthwhile_)"></a>Is It Worthwhile?</h2>
<p>So, is lazy loading a good idea?</p>
<p>Occasionally. Lazy loading, aside from the case of avoiding foreign
library dependencies, is an optimization technique, and as such it&rsquo;s
good to have in a narrow band of cases. In particular, lazy loading is
useful for large blocks of code that are unlikely to be executed in a
typical run of a program (not just &ldquo;executed infrequently&rdquo;). For
macros, the bar is higher because of the difficulty of separating
transformer code from residual code, and the danger of getting it
wrong. Lazy transformer loading is useful in cases like analyzers and
optimizers. The rest of the time, you&rsquo;re better off trusting Racket to
do the right thing.</p>
<p>Don&rsquo;t use lazy loading for code that can be split off into separate
modules just as easily. For example, <a class="RktModLink Sq" data-pltdoc="x" href="https://docs.racket-lang.org/reference/contracts.html"><span class="RktSym">racket/contract</span></a>
is a moderately large library, but the core features are available
from <span class="RktSym">racket/contract/base</span>, which is a smaller library.</p>
  <footer>
    <nav class="post-navigation" aria-label="Post Navigation">
  <div class="pure-menu">
  <ul class="pure-menu-list">
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="/blog/2011/10/in-praise-of-PostgreSQL-arrays"
         aria-label="Previous">
        <span aria-hidden="true">&larr; in praise of PostgreSQL arrays</span>
      </a>
    </li>
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="/blog/2011/09/definitions-vs-enclosing-binding-forms"
         aria-label="Next">
        <span aria-hidden="true">definitions vs enclosing binding forms &rarr;</span>
      </a>
    </li>
  </ul>
  </div>
</nav>
  </footer>
</article>


        </div>
        <div class="page-copyright">
          <div class="page-copyright-icon">
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
              <img alt="Creative Commons License" style="border-width:0"
                   src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
          </div>
          <div class="page-copyright-text">
            Copyright 2011 Ryan Culpepper.
            This work is licensed under a
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
            Creative Commons Attribution-ShareAlike 4.0 International License</a>.
          </div>
        </div>
      </div>
    </div>

  </body>
</html>